# æ—¥æŠ¥æ¨¡æ¿ ä¸å«å•é‡å æ¯”ç»“è®º

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import matplotlib
import openpyxl  # è‡ªåŠ¨æ‰©åˆ—å®½ç”¨

# ---------- é…ç½® ----------
matplotlib.rcParams['font.sans-serif'] = ['Microsoft YaHei']
matplotlib.rcParams['axes.unicode_minus'] = False

# ---------- æ–‡ä»¶è·¯å¾„ ----------
file_path = r'C:\Uniuni-æ•°æ®åˆ†æè®°å½•\æ—¥æŠ¥\ä½¿ç”¨æ¨¡æ¿\æ—¥æŠ¥æ•°æ®1_1-pythonå¤„ç†-250926.xlsx'
output_excel_path = r"C:\jupyteræ–‡ä»¶\æ—¥æŠ¥æ•°æ®é€è§†è¡¨17.xlsx"

# ---------- è¯»å–æ•°æ® ----------
df = pd.read_excel(file_path)

# ---------- æ•°æ®è¿‡æ»¤ ----------
# df = df[df['induct_region'] == 'JFK']
df = df.dropna(subset=["zone"])

# ---------- ç”Ÿæˆé€è§†è¡¨ ----------
pivot = pd.pivot_table(
    df,
    index=['induct_region', 'partner_flag_nm', 'induct_region_dest_nm_flag', 'is_cross_region', 'dest_region'],
    columns='date_flag',
    values=['t199_count', 'ontime_delivery'],
    aggfunc='sum'
)

# ---------- æ±‡æ€» ----------
pivot_partner_flag = pivot.groupby(['induct_region', 'partner_flag_nm']).sum()
pivot_dest_flag = pivot.groupby(['induct_region', 'partner_flag_nm', 'induct_region_dest_nm_flag']).sum()

full_index = ['induct_region', 'partner_flag_nm', 'induct_region_dest_nm_flag', 'is_cross_region', 'dest_region']

# partner_flag æ±‡æ€»
pivot_partner_flag = pivot_partner_flag.reset_index()
for col in full_index:
    if col not in pivot_partner_flag.columns:
        pivot_partner_flag[col] = ''
pivot_partner_flag['induct_region_dest_nm_flag'] = pivot_partner_flag['partner_flag_nm'] + " æ±‡æ€»"
pivot_partner_flag['is_cross_region'] = 'æ±‡æ€»'
pivot_partner_flag['dest_region'] = ''
pivot_partner_flag = pivot_partner_flag.set_index(full_index)

# dest_flag æ±‡æ€»
pivot_dest_flag = pivot_dest_flag.reset_index()
for col in full_index:
    if col not in pivot_dest_flag.columns:
        pivot_dest_flag[col] = ''
pivot_dest_flag['is_cross_region'] = pivot_dest_flag['induct_region_dest_nm_flag'] + " æ±‡æ€»"
pivot_dest_flag['dest_region'] = ''
pivot_dest_flag = pivot_dest_flag.set_index(full_index)

pivot_full = pivot.copy()

# æ‹¼æ¥
pivot_all = pd.concat([pivot_partner_flag, pivot_dest_flag, pivot_full], axis=0, sort=False)
pivot_all = pivot_all.sort_index()

# è½¬æ¢ MultiIndex åˆ—
pivot_all.columns = [f"{col[0]}_{col[1]}" if isinstance(col, tuple) else col for col in pivot_all.columns]
pivot_all = pivot_all.reset_index()

# çˆ¶çº§ç™¾åˆ†æ¯”
# ---------- çˆ¶çº§ç™¾åˆ†æ¯”ï¼ˆç‰¹æ®Šå¤„ç† TEMU/éTEMU ç”¨ TOTAL æ±‡æ€»ï¼‰ ----------
pivot_all = pivot_all.reset_index()

# æ‰¾å‡ºæ±‡æ€»è¡Œ
parent_level = pivot_all[pivot_all['induct_region_dest_nm_flag'].astype(str).str.contains("æ±‡æ€»")]

# TOTAL æ±‡æ€»æ˜ å°„ï¼ˆæŒ‰ regionï¼‰
total_sum_map = {}
for idx, row in parent_level.iterrows():
    if row['partner_flag_nm'] == "TOTAL-å…¨é‡å®¢æˆ·":
        total_sum_map[row['induct_region']] = {
            'æœ¬å‘¨': row.get('t199_count_æœ¬å‘¨', 0),
            'ä¸Šå‘¨': row.get('t199_count_ä¸Šå‘¨', 0)
        }

# æ™®é€šæ±‡æ€»æ˜ å°„ï¼ˆpartner_flag_nm è‡ªèº«æ±‡æ€»ï¼‰
parent_sum_map = {}
for idx, row in parent_level.iterrows():
    key = (row['induct_region'], row['partner_flag_nm'])
    parent_sum_map[key] = {
        'æœ¬å‘¨': row.get('t199_count_æœ¬å‘¨', 0),
        'ä¸Šå‘¨': row.get('t199_count_ä¸Šå‘¨', 0)
    }

pivot_all['æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = np.nan
pivot_all['ä¸Šå‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = np.nan

for idx, row in pivot_all.iterrows():
    key = (row['induct_region'], row['partner_flag_nm'])

    # æ±‡æ€»è¡Œæ‰ç‰¹æ®Šå¤„ç†
    if pd.notna(row['induct_region_dest_nm_flag']) and "æ±‡æ€»" in str(row['induct_region_dest_nm_flag']):
        if row['partner_flag_nm'] in ["TEMU-åŠæ‰˜", "éTEMU-åŠæ‰˜"]:
            # ç”¨ TOTAL æ±‡æ€»ä½œä¸ºåˆ†æ¯
            total = total_sum_map.get(row['induct_region'], {}).get('æœ¬å‘¨', 0)
            if total:
                pivot_all.at[idx, 'æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = row.get('t199_count_æœ¬å‘¨', 0) / total

            total = total_sum_map.get(row['induct_region'], {}).get('ä¸Šå‘¨', 0)
            if total:
                pivot_all.at[idx, 'ä¸Šå‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = row.get('t199_count_ä¸Šå‘¨', 0) / total
        else:
            # TOTAL æ±‡æ€»æˆ–å…¶å®ƒ â†’ è‡ªèº«æ±‡æ€»
            if parent_sum_map.get(key, {}).get('æœ¬å‘¨', 0):
                pivot_all.at[idx, 'æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = row.get('t199_count_æœ¬å‘¨', 0) / parent_sum_map[key]['æœ¬å‘¨']
            if parent_sum_map.get(key, {}).get('ä¸Šå‘¨', 0):
                pivot_all.at[idx, 'ä¸Šå‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = row.get('t199_count_ä¸Šå‘¨', 0) / parent_sum_map[key]['ä¸Šå‘¨']
    else:
        # éæ±‡æ€»è¡Œ â†’ ç”¨çˆ¶çº§æ±‡æ€»
        if parent_sum_map.get(key, {}).get('æœ¬å‘¨', 0):
            pivot_all.at[idx, 'æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = row.get('t199_count_æœ¬å‘¨', 0) / parent_sum_map[key]['æœ¬å‘¨']
        if parent_sum_map.get(key, {}).get('ä¸Šå‘¨', 0):
            pivot_all.at[idx, 'ä¸Šå‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”'] = row.get('t199_count_ä¸Šå‘¨', 0) / parent_sum_map[key]['ä¸Šå‘¨']

pivot_all = pivot_all.set_index(full_index).sort_index()


# æŒ‰æ—¶ç‡
pivot_all['æŒ‰æ—¶ç‡_æœ¬å‘¨'] = pivot_all.get('ontime_delivery_æœ¬å‘¨', 0) / pivot_all.get('t199_count_æœ¬å‘¨', 1)
pivot_all['æŒ‰æ—¶ç‡_ä¸Šå‘¨'] = pivot_all.get('ontime_delivery_ä¸Šå‘¨', 0) / pivot_all.get('t199_count_ä¸Šå‘¨', 1)
pivot_all['æŒ‰æ—¶ç‡å¯¹æ¯”'] = pivot_all['æŒ‰æ—¶ç‡_æœ¬å‘¨'] - pivot_all['æŒ‰æ—¶ç‡_ä¸Šå‘¨']


# æ›¿æ¢ç©ºå€¼ã€NaNã€æŠ¥é”™å€¼ä¸º 0
pivot_all = pivot_all.fillna(0)

# ä¹Ÿå¯ä»¥æ›¿æ¢ä¸€äº›ç‰¹å®šçš„é”™è¯¯å€¼ï¼ˆæ¯”å¦‚æŠ¥é”™å€¼ -inf, inf æˆ–å…¶å®ƒæƒ…å†µï¼‰
pivot_all.replace([np.inf, -np.inf], 0, inplace=True)

# å†æ¬¡ç¡®ä¿æ²¡æœ‰NaNæˆ–è€…æŠ¥é”™å€¼
pivot_all = pivot_all.fillna(0)


# åˆ—åæ˜ å°„
column_rename_map = {
    't199_count_ä¸Šå‘¨': 'ä¸Šå‘¨199æ•°',
    't199_count_æœ¬å‘¨': 'æœ¬å‘¨199æ•°',
    'ontime_delivery_ä¸Šå‘¨': 'ä¸Šå‘¨æŒ‰æ—¶å¦¥æŠ•æ•°',
    'ontime_delivery_æœ¬å‘¨': 'æœ¬å‘¨æŒ‰æ—¶å¦¥æŠ•æ•°',
    'æŒ‰æ—¶ç‡_æœ¬å‘¨': 'æœ¬å‘¨æŒ‰æ—¶ç‡',
    'æŒ‰æ—¶ç‡_ä¸Šå‘¨': 'ä¸Šå‘¨æŒ‰æ—¶ç‡',
    'æŒ‰æ—¶ç‡å¯¹æ¯”': 'æŒ‰æ—¶ç‡å¯¹æ¯”'
}
pivot_all = pivot_all.rename(columns=column_rename_map)

desired_order = [
    'æœ¬å‘¨199æ•°', 'æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”', 'æœ¬å‘¨æŒ‰æ—¶å¦¥æŠ•æ•°', 'æœ¬å‘¨æŒ‰æ—¶ç‡',
    'ä¸Šå‘¨199æ•°', 'ä¸Šå‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”', 'ä¸Šå‘¨æŒ‰æ—¶å¦¥æŠ•æ•°', 'ä¸Šå‘¨æŒ‰æ—¶ç‡', 'æŒ‰æ—¶ç‡å¯¹æ¯”'
]
pivot_all = pivot_all[desired_order]

# æ’åºé€»è¾‘
partner_order = ['TOTAL-å…¨é‡å®¢æˆ·', 'TEMU-åŠæ‰˜', 'éTEMU-åŠæ‰˜']
dest_flag_order = ['çŸ­æœŸå¾…è¾¾æ ‡', 'é•¿æœŸå¾…ä¼˜åŒ–'] + [f"{p} æ±‡æ€»" for p in partner_order]
is_cross_region_order = ['same_region', 'cross_region'] + [f"{c} æ±‡æ€»" for c in dest_flag_order]

pivot_all = pivot_all.reset_index()

pivot_all['partner_flag_nm'] = pd.Categorical(
    pivot_all['partner_flag_nm'], categories=partner_order, ordered=True
)
pivot_all['induct_region_dest_nm_flag'] = pd.Categorical(
    pivot_all['induct_region_dest_nm_flag'], categories=dest_flag_order, ordered=True
)
pivot_all['is_cross_region'] = pd.Categorical(
    pivot_all['is_cross_region'], categories=is_cross_region_order, ordered=True
)

pivot_all['is_cross_region'] = pivot_all['is_cross_region'].cat.add_categories([''])
pivot_all['is_cross_region'] = pivot_all['is_cross_region'].fillna('')

pivot_all = pivot_all.sort_values(
    by=['induct_region', 'partner_flag_nm', 'induct_region_dest_nm_flag', 'is_cross_region', 'dest_region'],
    ascending=[True, True, True, True, True]
)

pivot_all = pivot_all.set_index(full_index)

# æ¢å¤å€¼è¡¨å¤´æ ·å¼
column_rename_map_multi = {
    ('t199_count', 'ä¸Šå‘¨'): 'ä¸Šå‘¨199æ•°',
    ('t199_count', 'æœ¬å‘¨'): 'æœ¬å‘¨199æ•°',
    ('ontime_delivery', 'ä¸Šå‘¨'): 'ä¸Šå‘¨æŒ‰æ—¶å¦¥æŠ•æ•°',
    ('ontime_delivery', 'æœ¬å‘¨'): 'æœ¬å‘¨æŒ‰æ—¶å¦¥æŠ•æ•°',
    ('æŒ‰æ—¶ç‡_æœ¬å‘¨', ''): 'æœ¬å‘¨æŒ‰æ—¶ç‡',
    ('æŒ‰æ—¶ç‡_ä¸Šå‘¨', ''): 'ä¸Šå‘¨æŒ‰æ—¶ç‡',
    ('æŒ‰æ—¶ç‡å¯¹æ¯”', ''): 'æŒ‰æ—¶ç‡å¯¹æ¯”'
}

if isinstance(pivot_all.columns, pd.Index) and pivot_all.columns.nlevels == 1:
    new_columns = []
    for col in pivot_all.columns:
        if '_' in col:
            parts = col.rsplit('_', 1)
            new_columns.append((parts[0], parts[1]))
        else:
            new_columns.append((col, ''))
    pivot_all.columns = pd.MultiIndex.from_tuples(new_columns)

pivot_all.columns = [
    column_rename_map_multi.get(col, f"{col[0]}_{col[1]}" if col[1] else col[0])
    for col in pivot_all.columns
]

# æ ·å¼è®¾ç½®
def style_pivot(df):
    styler = df.style.set_properties(**{
        'font-family': 'Microsoft YaHei',
        'font-size': '9pt',
        'vertical-align': 'middle',
        'text-align': 'left'
    }).set_table_styles([
        {'selector': 'th', 'props': [('vertical-align', 'top'), ('text-align', 'left')]}
    ])

    styler = styler.format({
        'æœ¬å‘¨199æ•°': '{:,.0f}',
        'ä¸Šå‘¨199æ•°': '{:,.0f}',
        'æœ¬å‘¨æŒ‰æ—¶å¦¥æŠ•æ•°': '{:,.0f}',
        'ä¸Šå‘¨æŒ‰æ—¶å¦¥æŠ•æ•°': '{:,.0f}',
        'æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”': '{:.2%}',
        'ä¸Šå‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”': '{:.2%}',
        'æœ¬å‘¨æŒ‰æ—¶ç‡': '{:.2%}',
        'ä¸Šå‘¨æŒ‰æ—¶ç‡': '{:.2%}',
        'æŒ‰æ—¶ç‡å¯¹æ¯”': '{:.2%}'
    })

    styler = styler.map(lambda v: 'color:red;font-weight:bold' if isinstance(v, (float, int)) and 0 < v < 0.95 else '', subset=['æœ¬å‘¨æŒ‰æ—¶ç‡','ä¸Šå‘¨æŒ‰æ—¶ç‡'])

    def color_bar(v):
        if isinstance(v, (float, int)):
            pct = min(abs(v)*100, 100)
            if v < 0:
                return f'background: linear-gradient(to right, red {pct}%, transparent {pct}%)'
            else:
                return f'background: linear-gradient(to right, blue {pct}%, transparent {pct}%)'
        return ''

    styler = styler.map(color_bar, subset=['æŒ‰æ—¶ç‡å¯¹æ¯”'])
    styler = styler.apply(lambda row: ['background-color:#eaffea' if row['æŒ‰æ—¶ç‡å¯¹æ¯”'] < 0 else '' for _ in row], axis=1)

    return styler

pivot_all = style_pivot(pivot_all)

# ---------- ä¿å­˜ Excel ----------
pivot_all.to_excel(output_excel_path, merge_cells=True)

# ---------- è‡ªåŠ¨è°ƒæ•´åˆ—å®½ ----------
wb = openpyxl.load_workbook(output_excel_path)
ws = wb.active

for col in ws.columns:
    max_length = 0
    column = col[0].column_letter
    for cell in col:
        try:
            if cell.value:
                max_length = max(max_length, len(str(cell.value)))
        except:
            pass
    adjusted_width = (max_length + 2)
    ws.column_dimensions[column].width = adjusted_width

wb.save(output_excel_path)
wb.close()

print(f"âœ… Excel å·²ç”Ÿæˆï¼ˆåˆ—å®½è‡ªé€‚åº”ï¼‰: {output_excel_path}")

pivot_all

# ---------- ç”Ÿæˆç»“è®º ----------
def generate_conclusion_with_filter(pivot_all, manual_region_order=None):
    conclusions = []
    pivot_plain = pivot_all.data if hasattr(pivot_all, "data") else pivot_all
    regions = pivot_plain.index.get_level_values('induct_region').unique()

    # ---------- åœ¨è¿™é‡Œåšæ‰‹åŠ¨æ’åº ----------
    if manual_region_order:
        # å…ˆå–æ‰‹åŠ¨é¡ºåºé‡Œæœ‰çš„
        ordered_regions = [r for r in manual_region_order if r in regions]
        # å†è¡¥å……æœªå‡ºç°åœ¨æ‰‹åŠ¨é¡ºåºé‡Œçš„
        ordered_regions += [r for r in regions if r not in manual_region_order]
    else:
        ordered_regions = regions

    for region in ordered_regions:
        df_region = pivot_plain.loc[region]
        region_lines = []

        for partner_flag in df_region.index.get_level_values('partner_flag_nm').unique():
            try:
                df_partner = df_region.loc[partner_flag]
            except KeyError:
                continue

            partner_lines = []

            # -------------------- æ‰¾æ±‡æ€»è¡Œ --------------------
            try:
                summary_rows = df_partner[
                    df_partner.index.get_level_values('induct_region_dest_nm_flag').astype(str).str.contains("æ±‡æ€»")
                ]
                if not summary_rows.empty:
                    for dest_flag in summary_rows.index.get_level_values('induct_region_dest_nm_flag').unique():
                        row = summary_rows.xs(dest_flag, level='induct_region_dest_nm_flag')
                        if isinstance(row, pd.DataFrame):
                            row = row.loc[row['æœ¬å‘¨199æ•°'].idxmax()] if not row.empty else row.iloc[0]
                        if row["æœ¬å‘¨199æ•°"] > 0:
                            status = "è¾¾æ ‡" if row["æœ¬å‘¨æŒ‰æ—¶ç‡"] >= 0.95 else "ä¸è¾¾æ ‡"
                            rate = f"{row['æœ¬å‘¨æŒ‰æ—¶ç‡']*100:.1f}%"
                            change = f"{row['æŒ‰æ—¶ç‡å¯¹æ¯”']*100:+.1f}pp"
                            partner_lines.append(f"{partner_flag}ï¼š{status}({rate})ï¼Œå‘¨ç¯æ¯”{change}")
            except Exception:
                pass

            # -------------------- çŸ­æœŸ / é•¿æœŸç»†åˆ†ï¼ˆè¿‡æ»¤ NaNï¼‰ --------------------
            dest_flags = [
                df for df in df_partner.index.get_level_values('induct_region_dest_nm_flag').unique()
                if pd.notna(df) and str(df).strip() != "" and "æ±‡æ€»" not in str(df)
            ]

            for dest_flag in dest_flags:
                try:
                    df_dest = df_partner.xs(dest_flag, level='induct_region_dest_nm_flag')
                    if isinstance(df_dest, pd.DataFrame):
                        if df_dest.empty:
                            continue
                        row = df_dest.loc[df_dest['æœ¬å‘¨199æ•°'].idxmax()]
                    else:
                        row = df_dest

                    if row["æœ¬å‘¨199æ•°"] <= 0:
                        continue

                    # ===== è®¡ç®—æœ¬å‘¨199æ•°é‡å æ¯” =====
                    pct = row.get('æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”', np.nan)
                    pct_str = f"{pct*100:.1f}%" if pd.notna(pct) else ""

                    status = "è¾¾æ ‡" if row["æœ¬å‘¨æŒ‰æ—¶ç‡"] >= 0.95 else "ä¸è¾¾æ ‡"
                    rate = f"{row['æœ¬å‘¨æŒ‰æ—¶ç‡']*100:.1f}%"
                    change = f"{row['æŒ‰æ—¶ç‡å¯¹æ¯”']*100:+.1f}pp"

                    # åœ¨è¾¾æ ‡/ä¸è¾¾æ ‡å‰åŠ 199æ•°é‡å æ¯”
                    partner_lines.append(f"{dest_flag}ï¼š{status}({rate})ï¼Œå‘¨ç¯æ¯”{change}")

                    # TEMU / éTEMU æ‰æœ‰æœ¬åœ°ã€è·¨åŒº
                    if partner_flag != "TOTAL-å…¨é‡å®¢æˆ·":
                        try:
                            df_local = df_partner.xs((dest_flag, "same_region"), level=['induct_region_dest_nm_flag', 'is_cross_region'])
                            if isinstance(df_local, pd.DataFrame) and not df_local.empty:
                                row_local = df_local.loc[df_local['æœ¬å‘¨199æ•°'].idxmax()]
                                if row_local["æœ¬å‘¨199æ•°"] > 0:
                                    status_local = "è¾¾æ ‡" if row_local["æœ¬å‘¨æŒ‰æ—¶ç‡"] >= 0.95 else "ä¸è¾¾æ ‡"
                                    rate_local = f"{row_local['æœ¬å‘¨æŒ‰æ—¶ç‡']*100:.1f}%"
                                    change_local = f"{row_local['æŒ‰æ—¶ç‡å¯¹æ¯”']*100:+.1f}pp"
                                    pct_local1 = row_local.get('æœ¬å‘¨199æ•°çˆ¶çº§ç™¾åˆ†æ¯”', np.nan)
                                    pct_str_local1 = f"{pct_local1*100:.1f}%" if pd.notna(pct_local1) else ""
                                    partner_lines.append(f"æœ¬åœ°ï¼š{status_local}({rate_local})ï¼Œå‘¨ç¯æ¯”{change_local}")
                        except KeyError:
                            pass

                        cross_lines_dict = {}
                        try:
                            df_cross = df_partner.xs(dest_flag, level='induct_region_dest_nm_flag')
                            if isinstance(df_cross, pd.DataFrame):
                                for idx, cross_row in df_cross.iterrows():
                                    if idx[-2] == "cross_region" and cross_row["æœ¬å‘¨199æ•°"] >= 50 and cross_row["æœ¬å‘¨æŒ‰æ—¶ç‡"] < 0.95:
                                        rate_cross = f"{cross_row['æœ¬å‘¨æŒ‰æ—¶ç‡']*100:.1f}%"
                                        change_cross = f"{cross_row['æŒ‰æ—¶ç‡å¯¹æ¯”']*100:+.1f}pp"
                                        dest_region_cross = idx[-1]
                                        cross_lines_dict.setdefault(region, []).append(
                                            f"{dest_region_cross}ï¼ˆ{rate_cross}ï¼Œ{change_cross}ï¼‰"
                                        )
                        except KeyError:
                            pass

                        if cross_lines_dict:
                            for start_region, dest_infos in cross_lines_dict.items():
                                partner_lines.append(
                                    f"è·¨åŒºä¸è¾¾æ ‡å¹²çº¿ï¼ˆ>=50å•ï¼‰ï¼š{start_region}åˆ°" + "ã€".join(dest_infos)
                                )
                        else:
                               # å¦‚æœæ²¡æœ‰ç¬¦åˆæ¡ä»¶çš„å¹²çº¿ï¼Œæ·»åŠ â€œæ— â€çš„ä¿¡æ¯
                               partner_lines.append("è·¨åŒºä¸è¾¾æ ‡å¹²çº¿ï¼ˆ>=50å•ï¼‰ï¼šæ— ")

                except Exception:
                    continue

            if partner_lines:
                region_lines.extend(partner_lines)

        if region_lines:
            conclusions.append(f"{region}ï¼š\n" + "\n".join(region_lines))

    return conclusions







# ---------- ç”Ÿæˆç»“è®º ----------
ç»“è®º = generate_conclusion_with_filter(pivot_all, manual_region_order=["LAX", "JFK", "DFW", "ORD", "MIA", "ATL", "SJC", "SEA", "DEN"])


# ä¹‹åç”¨ç»“è®º_sorted

# print("\nğŸ“Œ ç»“è®ºï¼š")
# for line in ç»“è®º:
#     print(line)

# ---------- å°†ç»“è®ºè¾“å‡ºåˆ°txtæ–‡ä»¶ ----------
def save_conclusion_to_txt(conclusions, output_path):
    # åˆ›å»ºä¸€ä¸ªæ–‡ä»¶å¹¶å†™å…¥ç»“è®º
    with open(output_path, 'w', encoding='utf-8') as f:
        for idx, region in enumerate(conclusions):
            # æ·»åŠ é¡¹ç›®ç¼–å·
            project_prefix = f"é¡¹ç›®-{chr(65 + idx)}"  # é¡¹ç›®ç¼–å·ï¼šA, B, C ç­‰ç­‰
            f.write(f"{project_prefix}\n")
            f.write(f"{region}\n\n")

# è¾“å‡ºæ–‡ä»¶è·¯å¾„
# output_txt_path = r'C:\jupyteræ–‡ä»¶\æ—¥æŠ¥æ•°æ®ç»“è®º1.txt'

# è°ƒç”¨ä¿å­˜å‡½æ•°
# save_conclusion_to_txt(ç»“è®º, output_txt_path)

# print(f"âœ… ç»“è®ºå·²ä¿å­˜è‡³æ–‡ä»¶ï¼š{output_txt_path}")


# ==========================================================
# âœ… æ‹“å±•åŠŸèƒ½ï¼šç¯æ¯”ä¸ºè´Ÿæ—¶é«˜äº®æ˜¾ç¤ºï¼ˆä»…å¢å¼ºæ˜¾ç¤ºï¼Œä¸æ”¹åŠ¨åŸé€»è¾‘ï¼‰
# ==========================================================
from IPython.display import display, HTML
import re

def display_conclusion_with_color_only(conclusions):
    """
    å¯¹ç»“è®ºæ–‡å­—å¢åŠ é¢œè‰²æ˜¾ç¤ºï¼š
    - "ä¸è¾¾æ ‡" çº¢è‰²ï¼ˆè·¨åŒºä¸è¾¾æ ‡å¹²çº¿é™¤å¤–ï¼‰
    - ç¯æ¯”è´Ÿå€¼ -x.xpp çº¢è‰²
    - ç¯æ¯”æ­£å€¼ +x.xpp ç»¿è‰²
    """
    html_lines = []

    for line in conclusions:
        line_html = line

        # æ ‡çº¢ï¼šæ™®é€šâ€œä¸è¾¾æ ‡â€ï¼Œæ’é™¤è·¨åŒºä¸è¾¾æ ‡å¹²çº¿
        def mark_not_met(match):
            # æŸ¥æ‰¾â€œä¸è¾¾æ ‡â€å‰é¢æ˜¯å¦åŒ…å«â€œè·¨åŒºä¸è¾¾æ ‡å¹²çº¿â€ï¼Œè‹¥æ˜¯åˆ™ä¸æ ‡çº¢
            start_idx = match.start()
            if "è·¨åŒºä¸è¾¾æ ‡å¹²çº¿" in line[max(0, start_idx-20):start_idx+20]:
                return match.group(0)
            return f'<span style="color:red;font-weight:bold">{match.group(0)}</span>'

        line_html = re.sub(r'ä¸è¾¾æ ‡', mark_not_met, line_html)

        # æ ‡çº¢ï¼šç¯æ¯”è´Ÿå€¼
        line_html = re.sub(r'(-\d+\.?\d*pp)', r'<span style="color:red;font-weight:bold">\1</span>', line_html)
        # æ ‡ç»¿ï¼šç¯æ¯”æ­£å€¼
        line_html = re.sub(r'(\+\d+\.?\d*pp)', r'<span style="color:green;font-weight:bold">\1</span>', line_html)

        html_lines.append(
            f"<pre style='font-family:Microsoft YaHei;font-size:12px;text-align:left'>{line_html}</pre>"
        )

    display(HTML("<br>".join(html_lines)))

# æ‰§è¡Œå½©è‰²æ˜¾ç¤º
display_conclusion_with_color_only(ç»“è®º)


# 2ï¸âƒ£ è‹¥éœ€ä¿å­˜å¸¦æç¤ºç‰ˆæœ¬çš„ TXT æ–‡ä»¶ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š
output_txt_path_color = r'C:\jupyteræ–‡ä»¶\æ—¥æŠ¥æ•°æ®ç»“è®º_å¸¦æç¤º.txt'
save_conclusion_to_txt_with_hint(ç»“è®º, output_txt_path_color)
